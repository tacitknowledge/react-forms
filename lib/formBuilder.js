'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};Object.defineProperty(exports,'__esModule',{value:!0});exports.default=formBuilder;var _react=require('react'),_react2=_interopRequireDefault(_react),_lodash=require('lodash'),_formUtils=require('./formUtils'),_formConstants=require('./formConstants'),_formElementUtils=require('./formElement/formElementUtils'),_formElementFromState=require('./formElement/formElementFromState'),_formElementFromState2=_interopRequireDefault(_formElementFromState),_formElementFromEvt=require('./formElement/formElementFromEvt'),_formElementFromEvt2=_interopRequireDefault(_formElementFromEvt);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function isLikeStringOrNum(a){return!(0,_formUtils.isAReactEl)(a)}function isAnErrorEl(a){var b=a.type;return'FormError'===b.displayName}function isAFormErrorElClass(a){var b=a.props;return!!b['data-form-error']||!!b.htmlFor}function getErrorMsg(a,b){return(b[a]||[])[0]}function getErrorElProps(a,b){var c=b.errors,d=a.props.forInput;return _extends({},a.props,{msg:getErrorMsg(d,c)})}function getErrorClassElProps(a,b){var c=b.errors,d=a.props['data-form-error']||a.props.htmlFor,e=getErrorMsg(d,c)?_formConstants.ERROR_INPUT_CLASS_NAME:'';return _extends({},a.props,{className:a.props.className+' '+e})}function mergeCallbacks(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];return function(a){b.filter(function(a){return(0,_lodash.isFunction)(a)}).forEach(function(b){return b(a)})}}function getHasValueClassName(a){return(0,_lodash.isEmpty)((a||{}).value)?'':_formConstants.HAS_VALUE_CLASS_NAME}function getErrorInputClassName(a,b){var c=!!getErrorMsg(a,b);return c?_formConstants.ERROR_INPUT_CLASS_NAME:''}function getValidateEvents(a,b){var c=b.onValidate,d=b.onInvalidate,e=b.invalidateEvent,f=b.validateEvent;return e===a&&f===a?function(){d.apply(void 0,arguments),c.apply(void 0,arguments)}:e===a?d:f===a?c:null}var lastFocusValue=null;function getLastFocusValue(a){lastFocusValue=(0,_formElementFromEvt2.default)(a).getVal()}function getFormElProps(a,b){var c=a.props,d=c.name,e=c.onChange,f=c.onBlur,g=c.onFocus,h=c.className,i=b.errors,j=b.values,k=b.onValueChange,l=(0,_formElementFromState2.default)(a,j).getKeyVal();if((0,_lodash.isEmpty)(d))throw new Error(a.type+' element is missing a name attribute!',a);var m=mergeCallbacks(k,e,getValidateEvents('onChange',b)),n=mergeCallbacks(g,getLastFocusValue,getValidateEvents('onFocus',b)),o=mergeCallbacks(f,getValidateEvents('onBlur',b));return _extends({},a.props,{key:d,ref:(0,_formElementUtils.getFormElementRefName)(a),onChange:m,onFocus:n,onBlur:function(a){var b=(0,_formElementFromEvt2.default)(a).getVal()!==lastFocusValue;b&&o(a)},className:[h,getErrorInputClassName(d,i),getHasValueClassName(l)].join(' ')},l)}function getElProps(a,b){return(0,_formUtils.isAFormEl)(a)?getFormElProps(a,b):isAFormErrorElClass(a)?getErrorClassElProps(a,b):isAnErrorEl(a)?getErrorElProps(a,b):a.props}function getChildren(a,b){return(0,_formUtils.isAReactEl)(a)?b():a}function formBuilder(a){return _react2.default.Children.map(a.children,function(b){if(isLikeStringOrNum(b)||(0,_formUtils.isAFormGroup)(b))return b;var c=b.props.children,d=getElProps(b,a),e=getChildren(c,formBuilder.bind(null,_extends({},a,{children:c})));return[_react2.default.cloneElement(b,d,e)]})}